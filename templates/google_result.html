<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ç­”ã®ç¢ºèª - {{ title }}</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f5f7; padding: 15px; text-align: center; }
        .card { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); max-width: 450px; margin: auto; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .time-btn { border: 2px solid #ddd; padding: 10px 2px; border-radius: 12px; cursor: pointer; background: white; font-size: 0.8rem; display: flex; flex-direction: column; justify-content: center; min-height: 80px; transition: 0.2s; position: relative; }
        
        /* 3ã¤ã®çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .time-btn.ok { border-color: #00b900; background: #eaffea; color: #00b900; font-weight: bold; }
        .time-btn.triangle { border-color: #ff9800; background: #fff3e0; color: #ef6c00; font-weight: bold; }
        .time-btn.ng { border-color: #ff5252; background: #ffebee; color: #d32f2f; }

        .conflict-reason { font-size: 0.6rem; color: #d32f2f; margin-top: 4px; line-height: 1.1; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .status-badge { font-size: 0.65rem; padding: 2px 4px; border-radius: 4px; margin-top: 2px; }
        
        .submit-btn { width: 100%; padding: 18px; background: #00b900; color: white; border: none; border-radius: 35px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <h2 style="color:#00b900; margin-top:0;">ğŸ“… äºˆå®šã®æœ€çµ‚ç¢ºèª</h2>
        <p style="font-size:0.8rem; color:#666;">ã‚¿ãƒƒãƒ—ã™ã‚‹ã”ã¨ã« <b>OK â†’ â–³ â†’ NG</b> ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>

        <div class="grid" id="slotGrid"></div>

        <button class="submit-btn" onclick="sendResponse()">å›ç­”ã‚’ç¢ºå®šã™ã‚‹</button>
    </div>

    <script>
        const busySlots = {{ busy_slots | tojson }}; // ä¾‹: ["2025-12-30_20:00"]
        
        // ğŸ’¡ ä¿®æ­£ç‚¹1: 12:00ã‚’æ¶ˆã—ã€å¹¹äº‹ã®æŒ‡å®šæ™‚é–“ã«åˆã‚ã›ã‚‹ï¼ˆãƒ‡ãƒ¢ç”¨ã«18, 19, 20æ™‚ã«è¨­å®šï¼‰
        const dates = ["2025-12-30", "2025-12-31", "2026-01-01"];
        const times = ["18:00", "19:00", "20:00"]; 
        const grid = document.getElementById('slotGrid');

        dates.forEach(date => {
            times.forEach(time => {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                const slotKey = `${date}_${time}`;
                const displayDate = date.split('-').slice(1).join('/');

                // ğŸ’¡ ä¿®æ­£ç‚¹3: äºˆå®šãŒé‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã®åˆæœŸåˆ¤å®š
                const isBusy = busySlots.includes(slotKey);
                
                let currentStatus = isBusy ? "ng" : "ok";
                btn.classList.add(currentStatus);

                const updateBtnUI = () => {
                    let badge = currentStatus === "ok" ? "âœ… OK" : (currentStatus === "triangle" ? "â–³ é€”ä¸­ã‹ã‚‰" : "âŒ NG");
                    let reasonText = isBusy && currentStatus === "ng" ? `<div class="conflict-reason">âš ï¸äºˆå®šã‚ã‚Š</div>` : "";
                    
                    btn.innerHTML = `
                        <span style="font-size:0.7rem;">${displayDate}</span>
                        <b>${time}ã€œ</b>
                        <span class="status-badge">${badge}</span>
                        ${reasonText}
                    `;
                };

                updateBtnUI();

                // ğŸ’¡ ä¿®æ­£ç‚¹2: 3æŠï¼ˆãƒˆã‚°ãƒ«ï¼‰åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
                btn.onclick = () => {
                    if (currentStatus === "ok") {
                        currentStatus = "triangle";
                        btn.className = 'time-btn triangle';
                    } else if (currentStatus === "triangle") {
                        currentStatus = "ng";
                        btn.className = 'time-btn ng';
                    } else {
                        currentStatus = "ok";
                        btn.className = 'time-btn ok';
                    }
                    updateBtnUI();
                };
                grid.appendChild(btn);
            });
        });

        function sendResponse() {
            alert("å›ç­”ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
            window.close();
        }
    </script>
</body>
</html>
